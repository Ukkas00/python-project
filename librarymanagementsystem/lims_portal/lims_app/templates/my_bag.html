{% extends "index.html" %}
{% load static %}

{% block main_content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">My Bag</h3>
    <a href="/Books" class="btn btn-link">&larr; Back to Books</a>
  </div>

  {% if form_error %}
    <div class="alert alert-danger">{{ form_error }}</div>
  {% endif %}
  {% if form_success %}
    <div class="alert alert-success">{{ form_success }}</div>
  {% endif %}

  {% if bag_items and bag_items|length > 0 %}
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Book Title</th>
          <th>Author</th>
          <th>Quantity</th>
          <th style="width: 200px;">Rental Duration (days)</th>
          <th style="width: 140px;">Remove</th>
        </tr>
      </thead>
      <tbody>
        {% for item in bag_items %}
        <tr>
          <td>{{ item.book.title }}</td>
          <td>{{ item.book.author }}</td>
          <td>{{ item.quantity }}</td>
          <td>
            <form method="POST" action="/my-bag" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="action" value="set_duration" />
              <input type="hidden" name="order_id" value="{{ item.id }}" />
              <select class="form-select" name="rental_duration" onchange="this.form.submit()">
                <option value="7" {% if item.rental_duration_days == 7 %}selected{% endif %}>7</option>
                <option value="14" {% if item.rental_duration_days == 14 or not item.rental_duration_days %}selected{% endif %}>14</option>
                <option value="21" {% if item.rental_duration_days == 21 %}selected{% endif %}>21</option>
              </select>
            </form>
          </td>
          <td>
            <form method="POST" action="/my-bag" onsubmit="return confirm('Remove this item from your bag?');">
              {% csrf_token %}
              <input type="hidden" name="action" value="remove_item" />
              <input type="hidden" name="order_id" value="{{ item.id }}" />
              <button class="btn btn-outline-danger btn-sm" type="submit">Remove</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="alert alert-info" style="background-color: rgb(210, 123, 123); color: black;">Your bag is empty.</div>
  {% endif %}

  <div class="card mt-4">
    <div class="card-body">
      <h5 class="card-title">Borrower Details</h5>
      <form method="POST" action="/my-bag" autocomplete="off">
        {% csrf_token %}
        <input type="hidden" name="action" value="confirm_rental" />
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label" for="referance_id">Reference ID</label>
            <input type="text" class="form-control" id="referance_id" name="referance_id" value="{{ referance_id }}" required autocomplete="off" onmouseover="this.style.borderColor='#6b0505';" onmouseout="this.style.borderColor=''" />
            <div class="form-text"></div>
          </div>
          <div class="col-md-4">
            <label class="form-label" for="reader_name">Reader Name</label>
            <input type="text" class="form-control" id="reader_name" name="reader_name" value="{{ reader_name }}" placeholder="Enter your name" {% if referance_id %}readonly{% endif %} />
            {% if referance_id %}<div class="form-text">Reader Name is locked because a Reference ID is provided.</div>{% endif %}
          </div>
          <div class="col-md-4 d-grid">
            <button class="btn btn-danger" type="submit" {% if not bag_items or bag_items|length == 0 %}disabled{% endif %}>Confirm Rental</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="mt-3 text-muted">
      <h2 style="color: black;">Library Guidelines</h2>
      <ul>
        <li>Books must be returned in the same condition no scratches, no torn or missing pages, no writing inside.</li>
        <li>If a book is returned damaged (scratched, written on, missing pages), a fine of Rs. 500 will be charged.</li>
        <li>Manga/Fiction books must be returned within 2 weeks.</li>
        <li>Course/Academic books must be returned at the end of the semester.</li>
        <li>If returned late:
              Within 1 week late → Rs. 250 fine
              Up to 2 weeks late → Rs. 500 fi.</li>
        <li>Borrowing is free of charge if returned on time and without damage.</li>
        <li>Users who damage books or refuse to pay fines will have their account deactivated.</li>
        <li>For users above 18, repeated violation may result in a legal case being filed.
    </section>

  </div>
</div>
{% endblock %}


